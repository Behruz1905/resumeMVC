<?phpif ($ckey != "MODULE_INCLUDE") exit("Error module loading");if ($user_data['userType'] != "A") exit("Access denied");?><?phpif ($ckey != "MODULE_INCLUDE") exit("<center>Error module loading</center>");$section = intval($_REQUEST['section']);if (empty($action)) {    if (!empty($_GET['section'])) {        $result = $mysql->where(['parent_id' => 0, 'sect_id' => intval($_GET['section'])])->get('cats');    } else {        $result = $mysql->where('parent_id', 0)->get('cats');    }    print "<table border='1' cellspacing='0' cellpadding='3' id='catlist' bordercolor='#dddddd'  class='list_table portlet_table'>				   <tr class=\"portlet_table_title_tr\"><td colspan=8 ><h3>Kontentin kateqoriyaları</h3></td></tr>					<tr class=\"portlet_table_controls_tr\"><td colspan=8 >						<ul class=\"main_buttons\">							<li id=\"add_collection_button\"><a href=\"?smode=page&item=cats&action=add_cat&section=" . intval($_GET['section']) . "\" class=\"brown\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/add_big.png\" width=\"22\"></i><span>Add new</span></a></li>							<li id=\"excelExportButton\"><a href=\"#\" class=\"orange\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/export_excel.png\" width=\"22\"  /></i><span>Export</span></a></li>							<li id=\"edit_button\"><a href=\"#\" class=\"orange\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/edit.png\" width=\"22\"  /></i><span>Edit</span></a></li>							<li id=\"delete_button\"><a href=\"#\" class=\"orange\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/delete_n.png\" width=\"22\"  /></i><span>Delete</span></a></li>							<li id=\"addfields\"><a href=\"#\" class=\"orange\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/addfields.png\" width=\"22\"  /></i><span>Properties</span></a></li>							<li id=\"reloadButton\"><a href=\"#\" class=\"orange\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/reload.png\" width=\"22\"  /></i><span>Refresh</span></a></li>						</ul>					</tr>				   ";    print "<tr class=\"table_container\" >					<td width=\"900\">												<table id=\"data_table\" style=\"display:none;\" >							<thead>								<tr>								 <th width='38' >&nbsp;<strong>№</strong></th>								 <th width='267' >&nbsp;<strong>Adı</strong></th>								 <th  width=120 align=left>&nbsp;<strong>Açar sözləri</strong></th>								 <th  width=100 align=left>&nbsp;<strong>Bölmə</strong></th>								 <th  align=left>&nbsp;<strong>Aid oldugu kateqoriya</strong></th>								 <th width='76' >&nbsp;<strong>Dəyiş</strong></th>								 <th width='139' >&nbsp;<strong>Sil</strong></th>								 <th width='139' >&nbsp;<strong>ID</strong></th>							   </tr>						   </thead>						   <tbody>";    if (count($result) > 0) {        $i = 1;        foreach ($result as $row) {            print "<tr>												 <td>&nbsp;$i</td>												 <td>&nbsp;" . $row['name'] . "</td>												 <td>&nbsp;" . $row['keywords'] . "</td>												 <td>&nbsp;" . get_section_name($row['sect_id']) . "</td>												 <td>&nbsp;" . get_category($row['parent_id']) . "</td>												 <td>&nbsp;<a href='?smode=page&item=cats&action=editcat&catid=" . $row['id'] . "'>Dəyiş</a></td>												 <td>&nbsp;<a href='?smode=page&item=cats&action=delcat&catid=" . $row['id'] . "' onclick=\"return confirm('Silinsin ?');\">Sil</a></td>											   	 <td>" . $row['id'] . "</td>											   </tr>";            if (count($mysql->where('parent_id', $row['id'])->get('cats', 'id')) > 0) {                $row_2 = $mysql->limit(1)->where('parent_id', $row['id'])->get('cats');                if (!empty($_GET['section'])) {                    $row_2 = $mysql->limit(1)->where(['parent_id' => $row['id'], 'sect_id' => intval                    ($_GET['section'])])->get('cats');                }//                foreach ($result_2 as $row_2) {                print "<tr class=\"sub_rows\" >														 <td>&nbsp;</td>														 <td>&nbsp;&nbsp;&nbsp;&nbsp;" . $row_2['name'] . "</td>														 <td>&nbsp;" . $row_2['keywords'] . "</td>														 <td>&nbsp;" . get_section_name($row_2['sect_id']) . "</td>														 <td>&nbsp;" . get_category($row_2['parent_id']) . "</td>														 <td>&nbsp;<a href='?smode=page&item=cats&action=editcat&catid=" . $row_2['id'] . "'>Dəyiş</a></td>														 <td>&nbsp;<a href='?smode=page&item=cats&action=delcat&catid=" . $row_2['id'] . "' onclick=\"return confirm('Silinsin ?');\">Sil</a></td>													   	 <td>" . $row_2['id'] . "</td>													   </tr>";//				}            }            $i++;        }    } else {        "<tr><td colspan='4' align=center><b>Kateqoriya mövcud deyil</b></td></tr>";    }    print "	</tbody>							</table>							<div style='margin-top: 10px; width:100%;' id=\"main_grid\"></div>						  </td>						</tr>";    print "</table>";}if ($action == "add_cat") {    print "<form action='" . $_SERVER['SCRIPT_NAME'] . "' method=post  id=\"main_form\">";    print "<table width='830' border='1' cellpadding='3' cellspacing='0' class=\"edit_table\"  bordercolor='#dddddd'>			<tr class=\"edit_table_head_tr\">				<td colspan=\"2\"><h3>Kontentin kateqoriyaları</h3></td>			</tr>			<tr class=\"edit_table_controls_tr\">				<td colspan=\"2\">					<ul class=\"main_buttons\">						<li ><a href=\"#\" class=\"brown\" id=\"save_form_button\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/save.png\" width=\"22\"></i><span>Yadda saxla</span></a></li>					</ul>				</td>			</tr>					   <tr class=\"edit_table_body_tr\">			 <td align='right'>Aid oldugu kateqoriya &nbsp;</td>			 <td>";    print     "<select name=\"parent\"  class='ui_select'  style='width:400px;'>";    print        "<option value=\"0\">Root</option>";    $categories = $mysql->get('cats', 'id, name');    if (!empty($_GET['section'])) {        $categories = $mysql->wherer('sect_id', intval($_GET['section']))->get('cats', 'id, name');    }    foreach ($categories as $category) {        print "<option value=\"" . $category['id'] . "\">" . $category['name'] . "</option>";    }    print     "</select>";    print     "</td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Adı&nbsp;</td>			 <td><input type='text' name='cat_name' id='add_cat_name' autocomplete='off' class='ui_text' style='width:380px;'></td>		   </tr>		    <tr class=\"edit_table_body_tr\">			 <td align='right'>Adı (ru)&nbsp;</td>			 <td><input type='text' name='cat_name_ru' id='add_cat_name' autocomplete='off' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Adı (en)&nbsp;</td>			 <td><input type='text' name='cat_name_en' id='add_cat_name' autocomplete='off' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Açar sözü &nbsp;			 <span style='font-size:10px;'>(seperator ',')</span></td>			 <td><input type='text' name='cat_keywords' id='cat_keywords' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Məlumat &nbsp;</td>			 <td><textarea name='info' id=info ></textarea></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Məlumat ru&nbsp;</td>			 <td><textarea name='info_ru' id=info_ru ></textarea></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Məlumat en&nbsp;</td>			 <td><textarea name='info_en' id=info_en ></textarea></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Yer&nbsp;</td>			 <td><input type='text' name='place' id='place' class='ui_text' style='width:50px;'></td>		   </tr>			<tr class=\"edit_table_body_tr\">			 <td align='right'>Şəkil&nbsp;</td>			 <td><input type='text' name='cat_img' id='cat_img'  class='ui_text' style='width:380px;'> <a href=\"javascript:;\" onclick=\"mcImageManager.browse({fields : 'cat_img', relative_urls : true});\">[Şəkli seçin]</a> </td>		   </tr>";    /*    <tr>         <td align='right' valign=\"top\">Kordinat:</td>         <td>             <div style=\"margin-bottom:10px;\">                 Lat: <input type=\"text\" name=\"lat\" id=\"lat\"  class=\"main_ui_text\" style=\"width:210px;\" />                 Lng: <input type=\"text\" name=\"lng\" id=\"lng\" class=\"main_ui_text\"  style=\"width:210px;\" />             </div>             <div id='admin_mapdiv' style='width:550px; height:400px; border:1px solid #cccccc;'></div>             <input type=\"hidden\" name=\"latlng\" id=\"latlng\" value=\"40.29161166356436, 47.96742912597654\" />         </td>     </tr>     */    print   "		   		 </table>";    print "<input type=hidden name='action' value='do_add_cat'>";    print "<input type=hidden name='item' value='cats'>";    print "<input type=hidden name='smode' value='page'>";    print "</form><br/><br/><br/><br/>";}/* ---- do adding category ---------------------------------------------------- */if ($action == "do_add_cat") {    if ($_POST['cat_name'] == "") {        exit("Fields empty");    }    $cat_name = trim(addslashes(htmlspecialchars($_POST['cat_name'])));    $cat_name_en = trim(addslashes(htmlspecialchars($_POST['cat_name_en'])));    $cat_name_ru = trim(addslashes(htmlspecialchars($_POST['cat_name_ru'])));    $keywords = trim(addslashes(htmlspecialchars($_POST['cat_keywords'])));    $info = trim(addslashes($_POST['info']));    $info_ru = trim(addslashes($_POST['info_ru']));    $info_en = trim(addslashes($_POST['info_en']));    $parent = (int)$_POST['parent'];    $img = $_POST['cat_img'];    $url_name = clearUrlName($cat_name);    $place = trim(addslashes($_POST['place']));    $categoryInsert = $mysql->insert('cats', [        'name' => $cat_name,        'keywords' => $keywords,        'img' => $img,        'name_ru' => $cat_name_ru,        'name_en' => $cat_name_en,        'parent_id' => $parent,        'url_name' => $url_name,        'info' => $info,        'info_ru' => $info_ru,        'info_en' => $info_en,        'place' => $place    ]);    if($mysql->insert_id()) {        logw($item, $action, $query);        echo "<meta http-equiv=\"Refresh\" content=\"0; URL=?smode=" . $smode . "&item=" . $item . "&section=$section\">";  //change redirect        exit("<center></center>");    } else {        exit("Error in adding");    }}if ($action == "editcat") {    $id = $_GET['catid'];    $query = "SELECT * FROM cats WHERE id='$id'";    $result = $mysql->query($query,true);    $row = $result[0];    print "<form action='" . $_SERVER['SCRIPT_NAME'] . "' method=post id=\"main_form\">";    print "<table width='830' border='1' cellpadding='3' cellspacing='0' class=\"edit_table\" bordercolor='#dddddd'>						<tr class=\"edit_table_head_tr\">				<td colspan=\"2\"><h3>Kontentin kateqoriyaları</h3></td>			</tr>			<tr class=\"edit_table_controls_tr\">				<td colspan=\"2\">					<ul class=\"main_buttons\">						<li ><a href=\"#\" class=\"brown\" id=\"save_form_button\"><i class=\"icon-user\"><img src=\"jpanel/jpanel_img/save.png\" width=\"22\"></i><span>Yadda saxla</span></a></li>					</ul>				</td>			</tr>						   <tr class=\"edit_table_body_tr\">			 <td width='130' align='right'>Bölmə&nbsp;</td>			 <td width='382'>";    print "<select name=\"section\" id='manage_section_edit' class='ui_select'  style='width:400px;' >";    print     "<option value=\"0\">Seçin</option>";    //$result_sect = mysql_query("SELECT id,name FROM sections ");//    while ($row_sect = mysql_fetch_array($result_sect)) {//        print "<option value=\"" . $row_sect[0] . "\" ";////        if ($row['sect_id'] == $row_sect[0]) {//            print " selected ";//        }////        print ">" . $row_sect[1] . "</option>";//    }    print "</select>";    print     "</td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Aid oldugu kateqoriya &nbsp;</td>			 <td>";    print     "<select name=\"parent\" class='ui_select'  style='width:400px;' >";    print        "<option value=\"0\">Root</option>";    $query_parent = "SELECT id,name FROM cats WHERE parent_id=0";//    if (empty($_GET['section'])) {//        $query_parent .= " AND  sect_id=" . intval($row['sect_id']);//    } else {//        $query_parent .= " AND  sect_id=" . intval($_GET['section']);//    }    $result_parent = $mysql->query($query_parent,true);    foreach ( $result_parent as $row_parent) {        print "<option value=\"" . $row_parent[0] . "\" ";        if ($row_parent[0] == $row['parent_id']) {            print " selected ";        }        print ">" . $row_parent[1] . "</option>";    }    print     "</select>";    print     "</td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Adı&nbsp;</td>			 <td><input type='text' name='cat_name' id='add_cat_name' autocomplete='off' value='" . $row['name'] . "' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Adı   (ru)&nbsp;</td>			 <td><input type='text' name='cat_name_ru' id='add_cat_name' autocomplete='off' value='" . $row['name_ru'] . "' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Adı   (en)&nbsp;</td>			 <td><input type='text' name='cat_name_en' id='add_cat_name' autocomplete='off' value='" . $row['name_en'] . "' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Açar sözü &nbsp;</td>			 <td><input type='text' name='cat_keywords' id='cat_keywords' value='" . $row['keywords'] . "' class='ui_text' style='width:380px;'></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Məlumat&nbsp;</td>			 <td><textarea name='info' id=info >" . $row['info'] . "</textarea></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Məlumat ru&nbsp;</td>			 <td><textarea name='info_ru' id=info_ru >" . $row['info_ru'] . "</textarea></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Məlumat en&nbsp;</td>			 <td><textarea name='info_en' id=info_en >" . $row['info_en'] . "</textarea></td>		   </tr>		   <tr class=\"edit_table_body_tr\">			 <td align='right'>Şəkil&nbsp;</td>			 <td><input type='text' name='cat_img' id='cat_img' value='" . $row['img'] . "' class='ui_text' style='width:380px;' > <a href=\"javascript:;\" onclick=\"mcImageManager.browse({fields : 'cat_img', relative_urls : true});\">[Şəkli seçin]</a> </td>		   </tr>		   		   <tr class=\"edit_table_body_tr\">			 <td align='right' valign=\"top\">Yer&nbsp;</td>			 <td><input type='text' name='place' id='place' class='ui_text' style='width:50px;'></td>		   </tr>					<tr class=\"edit_table_body_tr\">			 <td align='right'>&nbsp;</td>			 <td><img src='" . $row['img'] . "' width='100' ></td>		   </tr>";    /*    <tr>         <td align='right' valign=\"top\">Kordinat:</td>         <td>             <div style=\"margin-bottom:10px;\">                 Lat: <input type=\"text\" name=\"lat\" id=\"lat\"  class=\"main_ui_text\" style=\"width:210px;\" />                 Lng: <input type=\"text\" name=\"lng\" id=\"lng\" class=\"main_ui_text\"  style=\"width:210px;\" />             </div>             <div id='admin_mapdiv' style='width:550px; height:400px; border:1px solid #cccccc;'></div>             <input type=\"hidden\" name=\"latlng\" id=\"latlng\" value=\"".$row['lat'].",".$row['lng']."\" />         </td>     </tr>    */    print  "</table>";    print "<input type=hidden name=action value='do_edit_cat'>";    print "<input type=hidden name=catid id=\"catid\" value='$id'>";    print "<input type=hidden name=smode value='page'>";    print "<input type=hidden name=item value='cats'>";    print "</form><br/><br/><br/><br/>";}if ($action == "do_edit_cat") {    if ($_POST['section'] == "" or $_POST['cat_name'] == "") {        exit("Fields empty");    }    $catid = intval($_POST['catid']);    $place = intval($_POST['place']);    $cat_name = trim(addslashes(htmlspecialchars($_POST['cat_name'])));    $cat_name_en = trim(addslashes(htmlspecialchars($_POST['cat_name_en'])));    $cat_name_ru = trim(addslashes(htmlspecialchars($_POST['cat_name_ru'])));    $keywords = trim(addslashes(htmlspecialchars($_POST['cat_keywords'])));    $info = trim(addslashes($_POST['info']));    $info_ru = trim(addslashes($_POST['info_ru']));    $info_en = trim(addslashes($_POST['info_en']));    $lat = SqlInjectFilterMini($_POST['lat']);    $lng = SqlInjectFilterMini($_POST['lng']);    $section = intval($_POST['section']);    $parent = intval($_POST['parent']);    $img = htmlspecialchars($_POST['cat_img']);    $data = [        "name" => $cat_name,        "keywords" =>  $keywords,        "img" => $img,        "name_ru" => $cat_name_ru,        "name_en" => $cat_name_en,        "parent_id" => $parent,        "lng" =>  $lng,        "lat" =>  $lat,        "info" =>  $info,        "info_ru" => $info_ru,        "info_en" => $info_en,        "place" => $place,    ];    $mysql->where("id", $catid);    $result = $mysql->update("cats",$data);    if ($result) {        logw($item, $action, $query);        echo "<meta http-equiv=\"Refresh\" content=\"0; URL=?smode=page&item=cats&section=$section\">";  //change redirect        exit("<center></center>");    } else {        exit("Error in editing");    }}if ($action == "delcat") {    $catid = $_GET['catid'];    $query = "DELETE FROM cats WHERE id='$catid'";    $result = $mysql->query($query);    if ($result) {        logw($item, $action, $catid);        echo "<meta http-equiv=\"Refresh\" content=\"0; URL=?smode=page&item=cats\">";  //change redirect        exit("<center></center>");    } else {        exit("Error in deleting");    }}?>
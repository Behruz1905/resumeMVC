<?php if ($ckey != "MODULE_INCLUDE") exit("Error module loading"); if($user_data['userType'] != "A") exit("Access denied");    ?><?php 	if ($ckey != "MODULE_INCLUDE") exit("<center>Error module loading</center>");	$mainlink = "?smode=".$smode."&item=".$item;	if($action == "menu_types") {					$result = $mysql->query("SELECT id,type_name FROM menu_type",true);		if($result) {			//$row = $result[0];			$i = 1;							print "<table border=1 style='border-collapse:collapse; ' cellpadding=5 celspacing=0 id='menu_types_table' >";			print 	"<tr>";			if(!is_array($result) || is_object($result))			    die("error");			 foreach ($result as $row)			 {					print "<td><a href='$mainlink&action=menus&type_id=".$row['id']."' >&nbsp;".$row['type_name']."</a></td>";					if(($i%4)==0 or $i == 4) { print "</tr><tr>"; }			 }			print 	"<tr>";			print "</table>";		}		}			if($_GET['action'] == "menus") 	{		$type_id = (int) $_GET['type_id'];		if($type_id == "" or !is_numeric($type_id) ) { exit("<br><center>Bad url</center>"); }				print "<table width='820' border='1' cellspacing='0' cellpadding='3' bordercolor='#dddddd' style='border-collapse:collapse;' class='list_table' >				  <tr class=\"admin_head_tr\">					<td width='34' >&nbsp;<strong>№</strong></td>					<td width='412' >&nbsp;<strong>Adı</strong></td>					<td width='205' >&nbsp;<strong>Kateqoriya / Material</strong></td>					<td width='63' >&nbsp;<strong>Sil</strong></td>					<td width='75' >&nbsp;<strong>Dəyiş</strong></td>				  </tr>";				  		$query = "SELECT id,cat_id,link,name,place,parent,(SELECT name FROM menu b WHERE a.parent = b.id) as parentname,(SELECT name FROM cats c WHERE c.id=a.cat_id) as catname,mode,article FROM menu a WHERE a.type_id='$type_id' ORDER BY parent,place";		$result = $mysql->query($query, true);				$i = 1;		$showsub = true;		foreach($result as $row) {				if($row['parentname'] == "") { $parent = "Root"; } else { $parent = $row['parentname']; }				if($row['mode'] == "article" && !empty($row['article'])) { 					$link_ar = get_material($row['article']);					$link = $link_ar['name']." <span style='font-size:10px; color:#33CC00;'>(Dəyiş)</span>";				} else 				if($row['mode'] == "page") { 					$link = $row['link']." <span style='font-size:10px; color:#33CC00;'>(Səhifə)</span>"; 				} else if($row['mode'] == "urllink") {					$link = "<a href='".$row['link']."' target=\"_blank\"> <span style='font-size:10px; color:#33CC00;'>(Link)</span></a>"; 				} else {					$link = get_category($row['cat_id'])." <span style='font-size:10px; color:#33CC00;'>(Kateqoriya)</span>"; 				}												if($parent != "Root" and $showsub == true) {					print "<tr><td bgcolor='#DDDDDD' colspan=5  style='padding-left:38px;'>&nbsp;<strong>Submenu</strong></td></tr>";					$showsub = false;					$i = 1;				}								print	  "<tr>							<td>&nbsp;$i</td>							<td>&nbsp;".$row['name']."</td>							<td>&nbsp;".$link."</td>							<td>&nbsp;<a href='$mainlink&action=delete_menu&menuid=".$row['id']."&type_id=".$type_id."' onclick=\"return confirm('Silinsin?');\">Sil</a></td>							<td>&nbsp;<a href='$mainlink&action=edit_menu&menuid=".$row['id']."&type_id=".$type_id."'>Dəyiş</a></td>						  </tr>";				$i++;		}								print "<tr><td bgcolor='#D2E4FA' colspan=5 align=right >&nbsp;<input type=button value='Əlavə et' style='background-color:#dddddd;' onclick=\"javascript: window.location.href='$mainlink&action=add_menu&type_id=".$type_id."'\">&nbsp;</td></tr>";				 		print 	"</table>";	}	if($_GET['action'] == "add_menu") {		$type_id = (int) $_GET['type_id'];		print "<form action='".$_SERVER['SCRIPT_NAME']."' method=post id='add_menu_form'>";		print "<table width='600' border='1' bordercolor='dddddd' cellspacing='0' cellpadding='3'>				  <tr>					 <td>Menunun tipi:  </td>					 <td>&nbsp;".get_menu_types($type_id)."</td>				  </tr>				  <tr>					<td width='150'>Kontentin tipi:</td>					<td width='438' nowrap>&nbsp;".get_categories('nan','showlink','add_cat_name')."&nbsp; 											<span id='material_select'>".show_material('nan','material_list')."</span>											<input type=text name=\"urllink_val\" id=\"urllink_val\" style=\"display:none; width:200px; \" placeholder=\"http://google.az\">											<select name=\"urllink_target\" id=\"urllink_target\" style=\"display:none;\">												<option value=\"_self\">Self</option>												<option value=\"_blank\">Blank</option>											</select>					</td>				  </tr>				  <tr>					<td>Yuxarı menu</td>					<td>&nbsp;".get_menu_parents()."</td>				  </tr>									  <tr>					<td>Adı az</td>					<td>&nbsp;<input type='text' name='name_az' id='ad_menu_name' ></td>				  </tr>				  				  <tr>					<td>Adı ru</td>					<td>&nbsp;<input type='text' name='name_ru' id='ad_menu_name' ></td>				  </tr>				  				  <tr>					<td>Adı en</td>					<td>&nbsp;<input type='text' name='name_en' id='ad_menu_name' ></td>				  </tr>				 				  <tr>				 <td colspan=2 align=right><input type='submit' value='Сохранить' name='ok_add_menu'></td>				</tr>				</table>";		print "<input type=hidden name='action' value='do_add_menu'>";		print "<input type=hidden name='smode' value='$smode'>";		print "<input type=hidden name='item' value='$item'>";		print "<input type=hidden name='type_id' value='$type_id'>";		print "</form>";	}		if($_POST['action'] == "do_add_menu") {				$type_id = (int) $_POST['type_id'];		if(!isset($_POST['ok_add_menu'])) { exit("Error"); }						if($_POST['section'] == 'link' ) { 			$link = $_POST['materials'];			$mode = "article"; 			$target = "";		} else		if($_POST['section'] == 'urllink' ) { 			$link = addslashes(htmlspecialchars($_POST['urllink_val']));			$mode = "urllink"; 			$target = clean($_POST['urllink_target']);		} else { 			$link = ""; 			$target = "";			if($_POST['section'] == 'page') {				$mode = "page";			} else {				$mode = "category";			}		}								$type = clean($_POST['menu_types']);		$category = clean($_POST['section']);		$parentid = clean($_POST['catparent']);		$name = clean($_POST['name_az']);				$name_ru = clean($_POST['name_ru']);		$name_en = clean($_POST['name_en']);								//$type = 1;				if($category == "link" or $category == "page") {			$category = 0;		}		$place_result = $mysql->query("SELECT MAX(place) as say FROM menu WHERE type_id='$type' AND  parent='$parentid' ",true);		//var_dump($place_result);		$place_row = $place_result[0]['say'];		$place_row = (int) $place_row;      //  insert($table, $data)    //		$query_menu =  "INSERT INTO menu (type_id,cat_id,name,place,article,link,mode,parent,name_az,name_ru,name_en,target)   //   //						VALUES ('$type','$category','$name','".($place_row+1)."','$link','$link','$mode','$parentid','$name','$name_ru','$name_en','$target') ";		 $data = [             "type_id" => $type,		     "cat_id" =>  $category,		      "name" => $name,		      "place" => $place_row+1,		     "article" => $link,		     "link" => $link,		     "mode" =>  $mode,		     "parent" =>  $parentid,		     "name_az" =>  $name,		     "name_ru" => $name_ru,             "name_en" => $name_en,             "target" => $target         ];		$result_menu = $mysql->insert("menu", $data);				/* if adding menu successfully */		if($result_menu) 		{ 			echo "<meta http-equiv=\"Refresh\" content=\"1; URL=$mainlink&action=menus&type_id=$type_id\">";  //change redirect			exit("<center>Удачно</center>"); 		}		else { exit("Error in adding menu"); }			}						if($_GET['action'] == "edit_menu") {				if(!isset($_GET['menuid']) or $_GET['menuid'] == "") { exit("Error"); }		$type_id = (int) $_GET['type_id'];		$menuid = $_GET['menuid'];		$query = "SELECT id,cat_id,name,place,link,parent,article,mode,type_id,name_ru,name_en FROM menu WHERE id='$menuid'";		$result = $mysql->query($query,true);		$row = $result[0];		print "<form action='".$_SERVER['SCRIPT_NAME']."' method=post id='add_menu_form'>";		print "<table width='741' border='1' cellspacing='0' cellpadding='3' style='border-collapse:collapse;' bordercolor='#DDDDDD'>			  			  <tr>				<td width='135'>Adı az</td>				<td width='594'>&nbsp;<input type='text' name='name_az' value='".$row['name']."' class='edit_menu_names'></td>			  </tr>			  			  <tr>				<td width='135'>Adı ru</td>				<td width='594'>&nbsp;<input type='text' name='name_ru' value='".$row['name_ru']."' class='edit_menu_names'></td>			  </tr>			  			  <tr>				<td width='135'>Adı en</td>				<td width='594'>&nbsp;<input type='text' name='name_en' value='".$row['name_en']."' class='edit_menu_names'></td>			  </tr>			  				<td>Menunun növü</td>				<td>&nbsp;".get_menu_types($row['type_id'])."</td>			  </tr>			  <tr>				<td>Baş menu</td>				<td>&nbsp;";		print "<select name=catparent  id='first_select' >				<option value='0'";				if($row['parent'] == "0") { print "selected"; }		print 	">Root</option>";				$sqlquery="SELECT id,name,parent,(select name from menu a where a.id = b.parent) as sparentname FROM menu b  ORDER BY  parent and id";				$res = $mysql->query($sqlquery,true);				$i=1;						foreach ($res as $ITEMGROUP ) {																$parent = $ITEMGROUP['parent'];								$location = $ITEMGROUP['sparentname'];								if($location == "") { $location = "Root"; }								print "<option value=\"$ITEMGROUP[id]\" ";								if($ITEMGROUP['id'] == $row['parent']) { print "selected"; }								print ">&nbsp; $i. $location -> $ITEMGROUP[name]";								$i++;						}		print "</select>";						print 	"</td>			  </tr>			  <tr>				<td>Material / Kateqoriya</td>				<td>&nbsp;";		 		if($row['mode'] ==  "article") { $row['cat_id'] = 'nan'; } else		if($row['mode'] == "page") { $row['cat_id'] = 'page'; }		if($row['mode'] == "urllink") { $row['cat_id'] = 'urllink'; }		print get_categories($row['cat_id'],'edit_ch','add_cat_name');		print "&nbsp;&nbsp;";				print "<input type=text name=\"urllink_val\" id=\"urllink_val\" style=\"display:none; width:200px; \" placeholder=\"http://google.az\" value=\"".$row['link']."\">											<select name=\"urllink_target\" id=\"urllink_target\" style=\"display:none;\">												<option value=\"_self\">Self</option>												<option value=\"_blank\">Blank</option>											</select>";				print show_material($row['article'],'material_list');		if($row['mode'] == "page") { print "&nbsp;<b>".get_menu_link($menuid)."</b>"; }						print 	"</td>			  </tr>			  <tr>				<td valign=top><br>&nbsp;Ardıcıllıq <div id='upd-dnd'> </div></td>				<td>&nbsp;";		/* place */		$type = $row['type_id'];		$queryplace = "SELECT id,name,place FROM menu WHERE parent=(select parent from menu where id='$menuid') and type_id='$type' ORDER BY place ";		$resultplace = $mysql->query($queryplace,true);		//$rows = mysql_fetch_array($resultplace);						print	"<table id='table' width='316' border='0' cellspacing='0' cellpadding=5>";		print 		"<tbody>";				 foreach ($resultplace as $rows)	{										 print "<tr id='".$rows['id']."' ><td width='25'>".$rows['place']."</td><td class='dragHandle'>&nbsp;</td><td>".$rows['name']."</td></tr>";									 }		print		"</tbody>";		print	 "</table>";		print    "<div id='upd-dnd' >&nbsp;</div>";		print "</td>			  </tr>			  <tr>			  <td colspan=2 align=right><input type=submit name='ok_edit_menu' value='Yadda saxla'></td>			  </tr>			</table>";		print "<input type=hidden name=action value='do_edit_menu'>";		print "<input type=hidden name=menuid value='$menuid'>";		print "<input type=hidden name='smode' value='$smode'>";		print "<input type=hidden name='item' value='$item'>";		print "<input type=hidden name='type_id' value='".$row['type_id']."'>";		print "</form>";		}	if($_POST['action'] == "do_edit_menu") {				if(!isset($_POST['ok_edit_menu'])) { exit("Error"); }		$type_id = (int) $_POST['type_id'];		//if($_POST['catparent'] == "" or $_POST['name_az'] == ""  or $_POST['menuid'] == "") { exit("Fields empty"); }		$menuid = $_POST['menuid'];		if($_POST['section'] == 'link' ) { 			$link = $_POST['materials'];			$mode = "article"; 		}  else		if($_POST['section'] == 'urllink' ) { 			$link = addslashes(htmlspecialchars($_POST['urllink_val']));			$mode = "urllink"; 			$target = clean($_POST['urllink_target']);		}  else { 			$link = ""; 			if($_POST['section'] == 'page') {				$mode = "page";			} else {				$mode = "category";			}		}				$category = clean($_POST['section']);		$parentid = clean($_POST['catparent']);		$name = clean($_POST['name_az']);				$name_ru = clean($_POST['name_ru']);		$name_en = clean($_POST['name_en']);				$type = clean($_POST['menu_types']);										if($mode == "page") { // page mode			$query_menu = "UPDATE menu SET name='$name',parent='$parentid',type_id='$type',mode='page',name_az='$name',name_ru='$name_ru',name_en='$name_en' WHERE id='$menuid' ";		} else 		if($mode == "article") {			$query_menu = "UPDATE menu SET name='$name',parent='$parentid',article='$link',type_id='$type',mode='article',name_az='$name',name_ru='$name_ru',name_en='$name_en' WHERE id='$menuid' ";		} else if($mode == "urllink") {			$query_menu = "UPDATE menu SET name='$name',parent='$parentid',article='$link',type_id='$type',mode='urllink',name_az='$name',name_ru='$name_ru',name_en='$name_en',link='$link',target='$target' WHERE id='$menuid' ";		} else {			$query_menu = "UPDATE menu SET name='$name',parent='$parentid',cat_id='$category',type_id='$type',mode='category',name_az='$name',name_ru='$name_ru',name_en='$name_en'  WHERE id='$menuid' ";		}					$result_menu = mysql_query($query_menu);						if($result_menu) 		{ 			echo "<meta http-equiv=\"Refresh\" content=\"0; URL=".$mainlink."&action=menus&type_id=".$type_id."\">";  //change redirect			exit("<center></center>"); 		}		else { exit("Error in editing menu"); }		}		if($_GET['action'] == "delete_menu") {				$type_id = (int) $_GET['type_id'];		if(!isset($_GET['menuid']) or $_GET['menuid'] == "") { exit("Error"); }		$menuid = $_GET['menuid'];		$type = get_menu_type($menuid);				$result_menu = $mysql->query("DELETE FROM menu WHERE id='$menuid' ");		if($result_menu) 		{ 			echo "<meta http-equiv=\"Refresh\" content=\"0; URL=".$mainlink."&action=menus&type_id=".$type_id."\">";  //change redirect			exit("<center></center>"); 		}		else { exit("Error"); }		}?>